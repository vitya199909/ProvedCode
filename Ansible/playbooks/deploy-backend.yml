---
- name: Deploy Backend Application
  hosts: backend
  become: yes
  
  vars:
    artifact_file: "provedcode-backend-{{ backend_version | default('latest') }}.jar"
    app_name: provedcode
    app_port: "{{ backend_port | default(8080) }}"
    db_port: "{{ db_port | default(5432) }}"
    
  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        connect_timeout: 30
        sleep: 5
        delay: 5
        timeout: 300
    
    - name: Gather facts
      setup:
    
    - name: Ensure deploy directory exists
      file:
        path: "{{ backend_deploy_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0755'
    
    - name: Stop backend service if running
      systemd:
        name: provedcode-backend
        state: stopped
      ignore_errors: yes
    
    - name: Download artifact from Artifactory
      get_url:
        url: "{{ artifactory_url }}/artifactory/{{ artifactory_repo }}/{{ artifact_file }}"
        dest: "{{ backend_deploy_dir }}/application.jar"
        force: yes
      when: artifactory_url is defined
      
    - name: Copy artifact from local (alternative)
      copy:
        src: "{{ artifact_path }}"
        dest: "{{ backend_deploy_dir }}/application.jar"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0644'
      when: artifact_path is defined and artifact_path | length > 0
    
    - name: Create application.properties
      template:
        src: ../templates/application.properties.j2
        dest: "{{ backend_deploy_dir }}/application.properties"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: '0600'
    
    - name: Create systemd service file
      template:
        src: ../templates/backend.service.j2
        dest: /etc/systemd/system/provedcode-backend.service
        mode: '0644'
      notify: reload systemd
    
    - name: Start and enable backend service
      systemd:
        name: provedcode-backend
        state: started
        enabled: yes
        daemon_reload: yes
    
    - name: Wait a moment for service to start
      pause:
        seconds: 10
    
    - name: Check service status
      command: systemctl status provedcode-backend
      register: service_status
      ignore_errors: yes
    
    - name: Show service status
      debug:
        var: service_status.stdout_lines
    
    - name: Check backend logs
      command: journalctl -u provedcode-backend -n 50 --no-pager
      register: backend_logs
      ignore_errors: yes
    
    - name: Show backend logs
      debug:
        var: backend_logs.stdout_lines
    
    - name: Wait for backend to be ready
      wait_for:
        port: "{{ app_port }}"
        delay: 5
        timeout: 120
      ignore_errors: yes
      register: backend_ready
    
    - name: Show backend readiness status
      debug:
        msg: "Backend port {{ app_port }} is {{ 'READY' if backend_ready is succeeded else 'NOT READY - Check DB credentials' }}"
        
    - name: Check backend health
      uri:
        url: "http://localhost:{{ app_port }}/actuator/health"
        status_code: 200
      retries: 5
      delay: 10
      
  handlers:
    - name: reload systemd
      systemd:
        daemon_reload: yes
